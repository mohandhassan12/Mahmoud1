<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>نظام إدارة خصومات الموظفين</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Icons & SweetAlert & Excel -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --purple-900: #2b0b3a;
      --purple-700: #4b0f5b;
      --purple-500: #7a2aa2;
      --white: #ffffff;
      --card-radius: 14px;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(180deg, var(--purple-900), #12021a);
      color: var(--white);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding-bottom:40px;
    }
    .wrap{max-width:1100px;margin:18px auto;padding:0 16px;}
    .header{
      background: linear-gradient(90deg, rgba(122,42,162,1), rgba(75,15,91,1));
      border-radius: var(--card-radius);
      padding:20px;
      text-align:center;
      box-shadow:0 8px 30px rgba(0,0,0,0.4);
    }
    .header h1{margin:0;font-size:20px;font-weight:700}
    .header p{margin:6px 0 0;opacity:.9;font-size:13px}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border-radius: var(--card-radius);
      padding:14px;
      margin-top:16px;
      box-shadow:0 10px 30px rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.03);
    }
    .card .card-header{
      background:transparent;
      border-bottom:none;
      padding:0 0 10px 0;
      color:var(--white);
      font-weight:700;
      display:flex;
      align-items:center;
      gap:8px;
      font-size:15px;
    }

    input.form-control, textarea.form-control, select.form-select{
      background: rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.06);
      color:var(--white);
      border-radius:10px;
      padding:10px 12px;
    }
    input::placeholder, textarea::placeholder{color:rgba(255,255,255,0.55)}
    .btn-primary{
      background: linear-gradient(90deg,var(--purple-700),var(--purple-500));
      border:none;color:var(--white);box-shadow:0 6px 18px rgba(122,42,162,0.25);
    }
    .btn-outline-light{
      color:var(--white);
      border-color: rgba(255,255,255,0.08);
    }
    .btn-small{padding:.375rem .6rem;font-size:.875rem}

    table.table{color:var(--white);font-size:14px}
    table thead th{background:transparent;border-bottom:1px solid rgba(255,255,255,0.06);opacity:.95}
    table tbody tr td{vertical-align:middle;border-top:1px solid rgba(255,255,255,0.02)}
    .small-muted{font-size:12px;color:rgba(255,255,255,0.65)}

    /* responsive tweaks */
    @media (max-width:767px){
      .header h1{font-size:18px}
      .header p{font-size:12px}
      .wrap{padding:0 10px}
      .row.g-3 > [class*="col-"]{padding-left:6px;padding-right:6px}
      .form-inline{display:flex;gap:8px;flex-direction:column}
      table{font-size:13px}
    }

  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1><i class="fas fa-file-invoice-dollar"></i> نظام إدارة خصومات الموظفين</h1>
      <p class="small-muted">واجهة واحدة متجاوبة. المفاتيح مخفية في Netlify Functions.</p>
    </div>

    <!-- الموظفين -->
    <div class="card">
      <div class="card-header"><i class="fas fa-users"></i> إدارة الموظفين</div>
      <div class="mt-2">
        <form id="employeeForm" class="row g-3">
          <div class="col-12 col-md-4"><input type="text" id="employeeName" class="form-control" placeholder="اسم الموظف" required></div>
          <div class="col-12 col-md-4"><input type="text" id="employeeId" class="form-control" placeholder="رقم الموظف" required></div>
          <div class="col-12 col-md-4"><input type="text" id="employeePosition" class="form-control" placeholder="الوظيفة" required></div>
          <div class="col-12 text-end"><button class="btn btn-primary btn-small" type="submit"><i class="fas fa-plus"></i> إضافة موظف</button></div>
        </form>
      </div>

      <hr style="border-color:rgba(255,255,255,0.03)">

      <div style="overflow:auto">
        <table class="table table-borderless">
          <thead>
            <tr><th style="width:6%">#</th><th>الاسم</th><th>الرقم</th><th>الوظيفة</th><th style="width:22%">الإجراء</th></tr>
          </thead>
          <tbody id="employeesTable"></tbody>
        </table>
      </div>
    </div>

    <!-- خصم -->
    <div class="card">
      <div class="card-header"><i class="fas fa-minus-circle"></i> تسجيل خصم جديد</div>
      <div class="mt-2">
        <form id="discountForm" class="row g-3">
          <div class="col-12 col-md-4"><select id="discountEmployee" class="form-select" required><option value="">اختر الموظف...</option></select></div>
          <div class="col-12 col-md-4"><select id="discountType" class="form-select" required><option value="">نوع الخصم...</option><option value="0.5">نصف يوم</option><option value="1">يوم كامل</option><option value="3">ثلاثة أيام</option></select></div>
          <div class="col-12 col-md-4"><input type="date" id="discountDate" class="form-control" required></div>
          <div class="col-12"><textarea id="discountReason" class="form-control" placeholder="سبب الخصم" required rows="2"></textarea></div>
          <div class="col-12 text-end"><button class="btn btn-primary btn-small" type="submit"><i class="fas fa-save"></i> حفظ الخصم</button></div>
        </form>
      </div>
    </div>

    <!-- السجلات -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div><i class="fas fa-list"></i> سجل الخصومات</div>
        <div class="d-flex gap-2">
          <button id="exportBtn" class="btn btn-outline-light btn-small"><i class="fas fa-download"></i> تصدير Excel</button>
          <button id="clearDiscountsBtn" class="btn btn-outline-light btn-small"><i class="fas fa-trash"></i> مسح كل الخصومات</button>
        </div>
      </div>

      <div style="overflow:auto;margin-top:8px">
        <table class="table table-borderless">
          <thead><tr><th>التاريخ</th><th>الموظف</th><th>الرقم</th><th>الوظيفة</th><th>نوع الخصم</th><th>السبب</th></tr></thead>
          <tbody id="discountsTable"></tbody>
        </table>
      </div>
    </div>

  </div>

<script>
/*
 Frontend uses Netlify Functions endpoints:
  - GET /api/employees
  - POST /api/employees
  - DELETE /api/employees
  - GET /api/discounts
  - POST /api/discounts
  - DELETE /api/discounts
Supabase credentials must be stored in Netlify environment variables:
  SUPABASE_URL
  SUPABASE_KEY
The functions are in /netlify/functions
*/

// helper: fetch JSON and handle errors
async function api(path, opts){
  opts = opts || {};
  opts.headers = Object.assign({ "Content-Type":"application/json" }, opts.headers || {});
  const res = await fetch("/api/" + path, opts);
  const text = await res.text();
  try { return JSON.parse(text); } catch(e){ return text; }
}

// load employees
async function loadEmployees(){
  const data = await api("employees");
  const tbody = document.getElementById("employeesTable");
  const select = document.getElementById("discountEmployee");
  tbody.innerHTML = ""; select.innerHTML = '<option value="">اختر الموظف...</option>';
  if(!Array.isArray(data)) return;
  data.forEach((e,i)=>{
    tbody.innerHTML += `<tr>
      <td>${i+1}</td>
      <td>${e.name}</td>
      <td>${e.emp_code}</td>
      <td>${e.position}</td>
      <td class="text-end">
        <button class="btn btn-small btn-outline-light" onclick="deleteEmployee('${e.id}')"><i class="fas fa-trash"></i> حذف</button>
      </td>
    </tr>`;
    select.innerHTML += `<option value="${e.id}">${e.name} (${e.emp_code})</option>`;
  });
}

// add employee
async function addEmployee(ev){
  ev.preventDefault();
  const body = {
    name: document.getElementById("employeeName").value.trim(),
    emp_code: document.getElementById("employeeId").value.trim(),
    position: document.getElementById("employeePosition").value.trim()
  };
  const data = await api("employees", { method:"POST", body: JSON.stringify(body) });
  if(data && data.message) return Swal.fire("خطأ", data.message, "error");
  Swal.fire("تم", "تم إضافة الموظف", "success");
  ev.target.reset();
  loadEmployees();
}

// delete employee
async function deleteEmployee(id){
  const confirmed = await Swal.fire({ title:"تأكيد حذف", text:"هل تريد حذف هذا الموظف؟", icon:"warning", showCancelButton:true, confirmButtonText:"حذف" });
  if(!confirmed.isConfirmed) return;
  await api("employees", { method:"DELETE", body: JSON.stringify({ id }) });
  Swal.fire("تم", "تم حذف الموظف", "success");
  loadEmployees(); loadDiscounts();
}

// load discounts
async function loadDiscounts(){
  const data = await api("discounts");
  const tbody = document.getElementById("discountsTable");
  tbody.innerHTML = "";
  if(!Array.isArray(data)) return;
  data.forEach(d=>{
    const name = d.employees ? d.employees.name : "";
    const code = d.employees ? d.employees.emp_code : "";
    const pos = d.employees ? d.employees.position : "";
    tbody.innerHTML += `<tr>
      <td>${d.discount_date}</td>
      <td>${name}</td>
      <td>${code}</td>
      <td>${pos}</td>
      <td>${d.discount_type}</td>
      <td>${d.reason}</td>
    </tr>`;
  });
}

// add discount
async function addDiscount(ev){
  ev.preventDefault();
  const body = {
    employee_id: document.getElementById("discountEmployee").value,
    discount_type: document.getElementById("discountType").value,
    discount_date: document.getElementById("discountDate").value,
    reason: document.getElementById("discountReason").value
  };
  const data = await api("discounts", { method:"POST", body: JSON.stringify(body) });
  if(data && data.message) return Swal.fire("خطأ", data.message, "error");
  Swal.fire("تم", "تم تسجيل الخصم", "success");
  ev.target.reset();
  loadDiscounts();
}

// export excel
async function exportExcel(){
  const data = await api("discounts");
  if(!Array.isArray(data) || data.length===0) return Swal.fire("تنبيه","لا يوجد بيانات لتصدير","info");
  const rows = data.map(d=>({
    "التاريخ": d.discount_date,
    "الاسم": d.employees ? d.employees.name : "",
    "الرقم": d.employees ? d.employees.emp_code : "",
    "الوظيفة": d.employees ? d.employees.position : "",
    "نوع الخصم": d.discount_type,
    "السبب": d.reason
  }));
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "خصومات");
  XLSX.writeFile(wb, "discounts.xlsx");
  Swal.fire("تم","تم تصدير الملف","success");
}

// clear discounts (protected by ADMIN_CLEAR_PASSWORD env)
async function clearDiscounts(){
  const { value: password } = await Swal.fire({
    title: "تأكيد الحذف",
    input: "password",
    inputLabel: "أدخل كلمة السر لمسح جميع الخصومات",
    inputPlaceholder: "كلمة السر",
    showCancelButton: true,
    confirmButtonText: "مسح"
  });
  if(!password) return;
  const resp = await api("discounts", { method:"DELETE", body: JSON.stringify({ clearAll:true, password }) });
  if(resp && resp.message) {
    if(resp.error) return Swal.fire("خطأ", resp.message, "error");
    Swal.fire("تم", resp.message, "success");
    loadDiscounts();
  } else {
    Swal.fire("خطأ", "خطأ غير متوقع", "error");
  }
}

document.addEventListener("DOMContentLoaded", ()=>{
  loadEmployees(); loadDiscounts();
  document.getElementById("employeeForm").addEventListener("submit", addEmployee);
  document.getElementById("discountForm").addEventListener("submit", addDiscount);
  document.getElementById("exportBtn").addEventListener("click", exportExcel);
  document.getElementById("clearDiscountsBtn").addEventListener("click", clearDiscounts);
});
</script>
</body>
</html>
