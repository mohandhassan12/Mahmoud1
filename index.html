<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نظام إدارة خصومات الموظفين</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- مكتبة Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body {
      background: linear-gradient(180deg,#eef3f7,#f8fafc);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .header {
      background: linear-gradient(135deg,#2c3e50,#4a6580);
      color: #fff;
      padding: 25px 0;
      border-radius: 0 0 12px 12px;
      margin-bottom: 30px;
      box-shadow: 0 6px 15px rgba(0,0,0,.12);
    }
    .card { border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,.05); border: none; }
    .card-header { background: linear-gradient(90deg,#3498db,#2c3e50); color:#fff; font-weight:bold; }
    .btn-primary { background: linear-gradient(135deg,#2c3e50,#4a6580); border: none; }
    .btn-success { background: linear-gradient(135deg,#27ae60,#219653); border: none; }
    .btn-danger { background: linear-gradient(135deg,#e74c3c,#c0392b); border: none; }
    .table thead th { background-color:#2c3e50;color:#fff; }
  </style>
</head>
<body>
  <div class="header text-center">
    <h1><i class="fas fa-file-invoice-dollar"></i> نظام إدارة خصومات الموظفين</h1>
    <p class="lead">إدارة وتتبع خصومات الموظفين بسهولة وكفاءة</p>
  </div>

  <div class="container">
    <!-- إدارة الموظفين -->
    <div class="card mb-4">
      <div class="card-header"><i class="fas fa-users"></i> إدارة الموظفين</div>
      <div class="card-body">
        <form id="employeeForm" class="row g-3">
          <div class="col-md-4"><input type="text" id="employeeName" class="form-control" placeholder="اسم الموظف" required></div>
          <div class="col-md-4"><input type="text" id="employeeId" class="form-control" placeholder="رقم الموظف" required></div>
          <div class="col-md-4"><input type="text" id="employeePosition" class="form-control" placeholder="الوظيفة" required></div>
          <div class="col-12"><button class="btn btn-primary" type="submit"><i class="fas fa-plus"></i> إضافة موظف</button></div>
        </form>
        <hr>
        <table class="table table-hover">
          <thead><tr><th>#</th><th>الاسم</th><th>الرقم</th><th>الوظيفة</th><th>الإجراء</th></tr></thead>
          <tbody id="employeesTable"></tbody>
        </table>
      </div>
    </div>

    <!-- تسجيل خصم -->
    <div class="card mb-4">
      <div class="card-header"><i class="fas fa-minus-circle"></i> تسجيل خصم جديد</div>
      <div class="card-body">
        <form id="discountForm" class="row g-3">
          <div class="col-md-4">
            <select id="discountEmployee" class="form-select" required>
              <option value="">اختر الموظف...</option>
            </select>
          </div>
          <div class="col-md-4">
            <select id="discountType" class="form-select" required>
              <option value="">نوع الخصم...</option>
              <option value="0.5">نصف يوم</option>
              <option value="1">يوم كامل</option>
              <option value="3">ثلاثة أيام</option>
            </select>
          </div>
          <div class="col-md-4"><input type="date" id="discountDate" class="form-control" required></div>
          <div class="col-12"><textarea id="discountReason" class="form-control" placeholder="سبب الخصم" required></textarea></div>
          <div class="col-12"><button class="btn btn-primary" type="submit"><i class="fas fa-save"></i> حفظ الخصم</button></div>
        </form>
      </div>
    </div>

    <!-- السجلات -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>
          <i class="fas fa-list"></i> سجل الخصومات
        </div>
        <div>
          <button id="exportBtn" class="btn btn-success btn-sm"><i class="fas fa-download"></i> تصدير Excel</button>
          <button id="clearDiscountsBtn" class="btn btn-danger btn-sm"><i class="fas fa-trash"></i> مسح كل الخصومات</button>
        </div>
      </div>
      <div class="card-body">
        <table class="table table-striped">
          <thead><tr><th>التاريخ</th><th>الموظف</th><th>الرقم</th><th>الوظيفة</th><th>نوع الخصم</th><th>السبب</th></tr></thead>
          <tbody id="discountsTable"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
const SUPABASE_URL = "https://aiuhkkksescqgvpuizdj.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpdWhra2tzZXNjcWd2cHVpemRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NDA0MzgsImV4cCI6MjA3MzUxNjQzOH0.nRN7g_MfiPUbYNx16J_aMWiwNkGRhZSAV72RB7JSlrM";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

document.addEventListener('DOMContentLoaded', async () => {
  await loadEmployees();
  await loadDiscounts();

  document.getElementById('employeeForm').addEventListener('submit', addEmployee);
  document.getElementById('discountForm').addEventListener('submit', addDiscount);
  document.getElementById('exportBtn').addEventListener('click', exportExcel);
  document.getElementById('clearDiscountsBtn').addEventListener('click', clearDiscounts);
});

async function loadEmployees(){
  const { data } = await supabase.from('employees').select('*').order('created_at',{ascending:false});
  const tbody = document.getElementById('employeesTable'); tbody.innerHTML='';
  const select = document.getElementById('discountEmployee'); select.innerHTML='<option value=\"\">اختر الموظف...</option>';
  if(!data) return;
  data.forEach((e,i)=>{
    tbody.innerHTML+=`<tr><td>${i+1}</td><td>${e.name}</td><td>${e.emp_code}</td><td>${e.position}</td>
      <td><button class=\"btn btn-sm btn-danger\" onclick=\"deleteEmployee('${e.id}')\">حذف</button></td></tr>`;
    select.innerHTML+=`<option value=\"${e.id}\">${e.name} (${e.emp_code})</option>`;
  });
}

async function addEmployee(ev){
  ev.preventDefault();
  const name=document.getElementById('employeeName').value;
  const emp_code=document.getElementById('employeeId').value;
  const position=document.getElementById('employeePosition').value;
  const { error }= await supabase.from('employees').insert({name,emp_code,position});
  if(error) return Swal.fire('خطأ',error.message,'error');
  Swal.fire('تم','تم إضافة الموظف بنجاح','success');
  ev.target.reset(); loadEmployees();
}

async function deleteEmployee(id){
  await supabase.from('employees').delete().eq('id',id);
  Swal.fire('تم','تم حذف الموظف','success');
  loadEmployees(); loadDiscounts();
}

async function loadDiscounts(){
  const { data } = await supabase.from('discounts').select('*, employees(name,emp_code,position)').order('created_at',{ascending:false});
  const tbody=document.getElementById('discountsTable'); tbody.innerHTML='';
  if(!data) return;
  data.forEach(d=>{
    tbody.innerHTML+=`<tr><td>${d.discount_date}</td><td>${d.employees.name}</td><td>${d.employees.emp_code}</td><td>${d.employees.position}</td><td>${d.discount_type}</td><td>${d.reason}</td></tr>`;
  });
}

async function addDiscount(ev){
  ev.preventDefault();
  const employee_id=document.getElementById('discountEmployee').value;
  const discount_type=document.getElementById('discountType').value;
  const discount_date=document.getElementById('discountDate').value;
  const reason=document.getElementById('discountReason').value;
  const { error }=await supabase.from('discounts').insert({employee_id,discount_type,discount_date,reason});
  if(error) return Swal.fire('خطأ',error.message,'error');
  Swal.fire('تم','تم تسجيل الخصم  ','success');
  ev.target.reset(); loadDiscounts();
}

// تصدير إلى Excel
async function exportExcel(){
  const { data } = await supabase.from('discounts')
    .select('discount_date, employees(name,emp_code,position), discount_type, reason');

  if(!data || data.length===0){
    return Swal.fire('تنبيه','لا يوجد بيانات لتصديرها','info');
  }

  const rows = data.map(d=>({
    "التاريخ": d.discount_date,
    "الاسم": d.employees.name,
    "الرقم": d.employees.emp_code,
    "الوظيفة": d.employees.position,
    "نوع الخصم": d.discount_type,
    "السبب": d.reason
  }));

  const worksheet = XLSX.utils.json_to_sheet(rows);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "خصومات");
  XLSX.writeFile(workbook, "discounts.xlsx");

  Swal.fire('تم','تم تصدير البيانات بنجاح','success');
}

// مسح كل الخصومات بكلمة سر
async function clearDiscounts(){
  const { value: password } = await Swal.fire({
    title: 'تأكيد الحذف',
    input: 'password',
    inputLabel: 'أدخل كلمة السر لمسح جميع الخصومات',
    inputPlaceholder: 'كلمة السر',
    inputAttributes: { autocapitalize: 'off', autocorrect: 'off' },
    showCancelButton: true,
    confirmButtonText: 'مسح',
    cancelButtonText: 'إلغاء'
  });

  if(password === 'admin123'){ // غير الباسورد زي ما تحب
    const { error } = await supabase.from('discounts').delete().neq('id',0);
    if(error) return Swal.fire('خطأ', error.message, 'error');
    Swal.fire('تم','تم مسح جميع الخصومات','success');
    loadDiscounts();
  } else if(password){
    Swal.fire('خطأ','كلمة السر غير صحيحة','error');
  }
}
</script>
</body>
</html>
