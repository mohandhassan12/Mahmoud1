<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>نظام إدارة خصومات الموظفين</title>

  <!-- مكتبات -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <style>
    :root{
      --bg-start:#eef3f7;
      --bg-end:#f8fafc;
      --purple-1:#2c3e50;
      --purple-2:#4a6580;
      --blue-1:#3498db;
    }
    html,body{height:100%;margin:0;font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:linear-gradient(180deg,var(--bg-start),var(--bg-end));color:#222}
    .wrap{max-width:1100px;margin:18px auto;padding:12px}
    .header{background:linear-gradient(135deg,var(--purple-1),var(--purple-2));color:#fff;padding:22px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.08);text-align:center}
    .header h1{margin:0;font-size:20px}
    .header p{margin:6px 0 0;font-size:13px;opacity:.9}

    .card{border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.04);border:0;margin-top:16px;background:#fff}
    .card .card-header{background:linear-gradient(90deg,var(--blue-1),var(--purple-1));color:#fff;font-weight:700;border-radius:12px 12px 0 0;padding:12px 16px}
    .card-body{padding:14px}
    .form-control, .form-select, textarea{border-radius:10px;background:rgba(0,0,0,0.03);border:1px solid rgba(0,0,0,0.06)}
    .btn-primary{background:linear-gradient(135deg,var(--purple-1),var(--purple-2));border:none;color:#fff;border-radius:10px}
    .btn-outline-dark{border-radius:10px}
    .table thead th{background:transparent;border-bottom:1px solid rgba(0,0,0,0.06)}
    .table tbody tr td{vertical-align:middle}
    @media (max-width:767px){
      .card .card-header{font-size:14px}
      .header h1{font-size:18px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1><i class="fas fa-file-invoice-dollar"></i> نظام إدارة خصومات الموظفين</h1>
      <p class="small">واجهة واحدة متجاوبة — تعمل مع جداول employees و discounts (id أرقام)</p>
    </div>

    <!-- الموظفين -->
    <div class="card">
      <div class="card-header"><i class="fas fa-users"></i> إدارة الموظفين</div>
      <div class="card-body">
        <form id="employeeForm" class="row g-3">
          <div class="col-12 col-md-4"><input id="employeeName" class="form-control" placeholder="اسم الموظف" required></div>
          <div class="col-12 col-md-4"><input id="employeeId" class="form-control" placeholder="رقم الموظف" required></div>
          <div class="col-12 col-md-4"><input id="employeePosition" class="form-control" placeholder="الوظيفة" required></div>
          <div class="col-12 text-end"><button class="btn btn-primary" type="submit"><i class="fas fa-plus"></i> إضافة موظف</button></div>
        </form>
        <hr>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead><tr><th style="width:6%">#</th><th>الاسم</th><th>الرمز</th><th>الوظيفة</th><th style="width:14%">الإجراء</th></tr></thead>
            <tbody id="employeesTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- تسجيل خصم -->
    <div class="card">
      <div class="card-header"><i class="fas fa-minus-circle"></i> تسجيل خصم جديد</div>
      <div class="card-body">
        <form id="discountForm" class="row g-3">
          <div class="col-12 col-md-4">
            <select id="discountEmployee" class="form-select" required>
              <option value="">اختر الموظف...</option>
            </select>
          </div>
          <div class="col-12 col-md-4">
            <select id="discountType" class="form-select" required>
              <option value="">نوع الخصم...</option>
              <option value="0.5">نصف يوم</option>
              <option value="1">يوم كامل</option>
              <option value="3">ثلاثة أيام</option>
            </select>
          </div>
          <div class="col-12 col-md-4"><input id="discountDate" type="date" class="form-control" required></div>
          <div class="col-12"><textarea id="discountReason" class="form-control" rows="2" placeholder="سبب الخصم" required></textarea></div>
          <div class="col-12 text-end"><button class="btn btn-primary" type="submit"><i class="fas fa-save"></i> حفظ الخصم</button></div>
        </form>
      </div>
    </div>

    <!-- السجلات -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div><i class="fas fa-list"></i> سجل الخصومات</div>
        <div class="d-flex gap-2">
          <button id="exportBtn" class="btn btn-outline-dark btn-sm"><i class="fas fa-download"></i> تصدير Excel</button>
          <button id="clearDiscountsBtn" class="btn btn-outline-dark btn-sm"><i class="fas fa-trash"></i> مسح كل الخصومات</button>
        </div>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped">
            <thead><tr><th>التاريخ</th><th>الموظف</th><th>الرمز</th><th>الوظيفة</th><th>نوع الخصم</th><th>السبب</th></tr></thead>
            <tbody id="discountsTable"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

<script>
/*
تأكد أنك أنشأت الجداول بالـ SQL serial وأنفخت البيانات.
هذا الكود يتصل مباشرة بـ Supabase. استبدل القيم بالـ URL و KEY الخاصين بمشروعك.
*/
const SUPABASE_URL = "https://aiuhkkksescqgvpuizdj.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpdWhra2tzZXNjcWd2cHVpemRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NDA0MzgsImV4cCI6MjA3MzUxNjQzOH0.nRN7g_MfiPUbYNx16J_aMWiwNkGRhZSAV72RB7JSlrM";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Helpers
function showErr(msg){ Swal.fire('خطأ', msg, 'error'); }
function showOk(msg){ Swal.fire('تم', msg, 'success'); }

// Load employees
async function loadEmployees(){
  try {
    const { data, error } = await supabase.from('employees').select('*').order('id',{ascending:true});
    if(error) return showErr(error.message);
    const tbody = document.getElementById('employeesTable');
    const select = document.getElementById('discountEmployee');
    tbody.innerHTML = ''; select.innerHTML = '<option value=\"\">اختر الموظف...</option>';
    if(!data) return;
    data.forEach((e,i)=>{
      tbody.insertAdjacentHTML('beforeend',
        `<tr>
          <td>${e.id}</td>
          <td>${escapeHtml(e.name)}</td>
          <td>${escapeHtml(e.emp_code)}</td>
          <td>${escapeHtml(e.position)}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-dark" onclick="deleteEmployee(${e.id})"><i class="fas fa-trash"></i> حذف</button>
          </td>
        </tr>`);
      select.insertAdjacentHTML('beforeend', <option value="${e.id}">${escapeHtml(e.name)} (${escapeHtml(e.emp_code)})</option>);
    });
  } catch (err) { showErr(err.message); }
}

// Add employee
async function addEmployee(ev){
  ev.preventDefault();
  const name = document.getElementById('employeeName').value.trim();
  const emp_code = document.getElementById('employeeId').value.trim();
  const position = document.getElementById('employeePosition').value.trim();
  if(!name||!emp_code||!position) return showErr('اكمل كل الحقول');
  const { data, error } = await supabase.from('employees').insert({ name, emp_code, position }).select();
  if(error) return showErr(error.message);
  showOk('تم إضافة الموظف');
  ev.target.reset();
  loadEmployees();
}

// Delete employee
async function deleteEmployee(id){
  const res = await Swal.fire({ title:'تأكيد حذف', text:'هل تريد حذف هذا الموظف؟', icon:'warning', showCancelButton:true, confirmButtonText:'نعم' });
  if(!res.isConfirmed) return;
  const { error } = await supabase.from('employees').delete().eq('id', id);
  if(error) return showErr(error.message);
  showOk('تم الحذف');
  loadEmployees(); loadDiscounts();
}

// Load discounts with joined employee info
async function loadDiscounts(){
  try {
    const { data, error } = await supabase
      .from('discounts')
      .select('id, discount_date, discount_type, reason, employees(id, name, emp_code, position)')
      .order('id',{ascending:false});
    if(error) return showErr(error.message);
    const tbody = document.getElementById('discountsTable'); tbody.innerHTML = '';
    if(!data) return;
    data.forEach(d=>{
      const emp = d.employees || {};
      tbody.insertAdjacentHTML('beforeend',
        `<tr>
          <td>${d.discount_date}</td>
          <td>${escapeHtml(emp.name||'')}</td>
          <td>${escapeHtml(emp.emp_code||'')}</td>
          <td>${escapeHtml(emp.position||'')}</td>
          <td>${escapeHtml(String(d.discount_type))}</td>
          <td>${escapeHtml(d.reason||'')}</td>
        </tr>`);
    });
  } catch(err){ showErr(err.message); }
}

// Add discount
async function addDiscount(ev){
  ev.preventDefault();
  const employee_id = parseInt(document.getElementById('discountEmployee').value);
  const discount_type = document.getElementById('discountType').value;
  const discount_date = document.getElementById('discountDate').value;
  const reason = document.getElementById('discountReason').value.trim();
  if(!employee_id || !discount_type || !discount_date || !reason) return showErr('اكمل كل الحقول');
  const { data, error } = await supabase.from('discounts').insert({ employee_id, discount_type, discount_date, reason }).select();
  if(error) return showErr(error.message);
  showOk('تم تسجيل الخصم');
  ev.target.reset();
  loadDiscounts();
}

// Export excel
async function exportExcel(){
  const { data, error } = await supabase.from('discounts').select('discount_date, discount_type, reason, employees(name, emp_code, position)');
  if(error) return showErr(error.message);
  if(!data || data.length===0) return Swal.fire('تنبيه','لا يوجد بيانات لتصديرها','info');
  const rows = data.map(d=>({
    "التاريخ": d.discount_date,
    "الاسم": d.employees?.name || '',
    "الرقم": d.employees?.emp_code || '',
    "الوظيفة": d.employees?.position || '',
    "نوع الخصم": d.discount_type,
    "السبب": d.reason
  }));
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "خصومات");
  XLSX.writeFile(wb, "discounts.xlsx");
  Swal.fire('تم','تم تصدير الملف','success');
}

// Clear all discounts (protected by prompt)
async function clearDiscounts(){
  const { value: password } = await Swal.fire({
    title: 'تأكيد الحذف',
    input: 'password',
    inputLabel: 'أدخل كلمة السر لمسح جميع الخصومات',
    inputPlaceholder: 'كلمة السر',
    showCancelButton: true,
    confirmButtonText: 'مسح'
  });
  if(!password) return;
  if(password !== 'admin123') return showErr('كلمة السر غير صحيحة');
  const { error } = await supabase.from('discounts').delete().neq('id',0);
  if(error) return showErr(error.message);
  showOk('تم مسح جميع الخصومات');
  loadDiscounts();
}

// small escape to prevent injected HTML from DB
function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

document.addEventListener('DOMContentLoaded', ()=>{
  loadEmployees();
  loadDiscounts();
  document.getElementById('employeeForm').addEventListener('submit', addEmployee);
  document.getElementById('discountForm').addEventListener('submit', addDiscount);
  document.getElementById('exportBtn').addEventListener('click', exportExcel);
  document.getElementById('clearDiscountsBtn').addEventListener('click', clearDiscounts);
});
</script>
</body>
</html>
